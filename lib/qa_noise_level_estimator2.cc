/* -*- c++ -*- */
/* 
 * Copyright 2013 Jiří Pinkava <j-pi@seznam.cz>.
 * 
 * This is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3, or (at your option)
 * any later version.
 * 
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 */

#include "qa_noise_level_estimator2.h"
#include <rstt/noise_level_estimator2.h>
#include "noise_level_estimator2_impl.h"
#include <cppunit/TestAssert.h>
#include <cmath>
#include <stdexcept>


namespace gr {
  namespace rstt {

    void
    qa_noise_level_estimator2::t1_1()
    {
      CPPUNIT_ASSERT_NO_THROW(noise_level_estimator2::make(.33, .05));
      CPPUNIT_ASSERT_THROW(noise_level_estimator2::make(1.33, .05),
          std::out_of_range);
      CPPUNIT_ASSERT_THROW(noise_level_estimator2::make(-.33, .05),
          std::out_of_range);
      CPPUNIT_ASSERT_THROW(noise_level_estimator2::make(.33, -.05),
          std::out_of_range);
      CPPUNIT_ASSERT_THROW(noise_level_estimator2::make(.33, .45),
          std::out_of_range);
    }

    void
    qa_noise_level_estimator2::t1_2()
    {
      noise_level_estimator2::sptr nle =
        noise_level_estimator2::make(.33, .05);

      const float data[] = {
        -3.1730, -3.5605, -4.0189, -4.0660, -4.0774, -4.0888, -4.0631, -4.0721,
        -4.0867, -4.0821, -4.0789, -4.0956, -4.1122, -4.1047, -4.1065, -4.0865,
        -4.0814, -4.0882, -4.0033, -3.9157, -3.9976, -4.0849, -4.0632, -3.8072,
        -3.5609, -3.7723, -3.9917, -4.0536, -4.0643, -4.0002, -3.8701, -3.9202,
        -4.0415, -4.0914, -4.0989, -4.0494, -3.8737, -3.8766, -4.0469, -4.0340,
        -4.0129, -4.0373, -4.0666, -4.0611, -4.0653, -4.0902, -4.0794, -4.0582,
        -4.0761, -4.0906, -4.0479, -4.0499, -4.0532, -4.0290, -4.0687, -4.0758,
        -4.0834, -4.1023, -4.0865, -4.0327, -4.0277, -4.0404, -4.0426, -4.0566,
        -4.0256, -4.0043, -4.0008, -4.0125, -4.0380, -4.0720, -4.0386, -3.9900,
        -4.0412, -4.0753, -4.0937, -4.1030, -4.0755, -4.0499, -4.0703, -4.0874,
        -4.0914, -4.0993, -4.0714, -4.0520, -4.0596, -4.0928, -4.0995, -4.0844,
        -4.0710, -4.0756, -4.0589, -4.0257, -4.0160, -4.0319, -4.0749, -4.0596,
        -4.0325, -4.0367, -4.0395, -4.0565, -4.0639, -4.0440, -4.0309, -4.0202,
        -4.0317, -4.0500, -4.0385, -4.0096, -4.0156, -4.0401, -4.0360, -3.8855,
        -3.7329, -3.6936, -3.8638, -4.0253, -3.8874, -3.0594, -2.6282, -3.2275,
        -3.9111, -4.0039, -4.0170, -4.0070, -4.0000, -4.0137, -4.0022, -3.9988,
        -4.0171, -4.0208, -4.0336, -4.0480, -4.0271, -3.9914, -3.9730, -3.9862,
        -4.0055, -4.0032, -3.9730, -3.9684, -3.9634, -3.9514, -3.9629, -3.9827,
        -3.9796, -3.9648, -3.8969, -3.6322, -3.6192, -3.8843, -3.9344, -3.4456,
        -2.6246, -2.7527, -3.6604, -3.9922, -3.9861, -3.9921, -3.9457, -3.9044,
        -3.9730, -4.0258, -4.0198, -3.9980, -3.9982, -3.9952, -3.9952, -3.9804,
        -3.9622, -3.9630, -3.9564, -3.9404, -3.9383, -3.9616, -4.0162, -4.0151,
        -3.9859, -3.9845, -3.9555, -3.9555, -3.9589, -3.9440, -3.9426, -3.9590,
        -3.9737, -3.9693, -3.9787, -3.9760, -3.9872, -3.9909, -3.9853, -3.9647,
        -3.9334, -3.8507, -3.6208, -3.6213, -3.8655, -3.8948, -3.2353, -2.3793,
        -2.5912, -3.6161, -3.9755, -3.9812, -3.9650, -3.9487, -3.9439, -3.9207,
        -3.9211, -3.9534, -3.9524, -3.9171, -3.9108, -3.9327, -3.9281, -3.9255,
        -3.9283, -3.9233, -3.9174, -3.9121, -3.9039, -3.9078, -3.9191, -3.9485,
        -3.9580, -3.9341, -3.9113, -3.9015, -3.8583, -3.7854, -3.8651, -3.9313,
        -3.8747, -3.5136, -3.3319, -3.6770, -3.9037, -3.9527, -3.9624, -3.9119,
        -3.8026, -3.8494, -3.9388, -3.9325, -3.8909, -3.8806, -3.8787, -3.8905,
        -3.9403, -3.9542, -3.9083, -3.9049, -3.9348, -3.9348, -3.9453, -3.9432,
        -3.9092, -3.8795, -3.9003, -3.9136, -3.9081, -3.9122, -3.9229, -3.9094,
        -3.8982, -3.9117, -3.9010, -3.8530, -3.8614, -3.8935, -3.8900, -3.8873,
        -3.9132, -3.8751, -3.7895, -3.4647, -3.2225, -3.5774, -3.8662, -3.4067,
        -2.1317, -1.7898, -2.6870, -3.7732, -3.9323, -3.9213, -3.9048, -3.9013,
        -3.8918, -3.8842, -3.8832, -3.8869, -3.8982, -3.9099, -3.9260, -3.9098,
        -3.8723, -3.8764, -3.9118, -3.9276, -3.9370, -3.9257, -3.8990, -3.9131,
        -3.9242, -3.8978, -3.8909, -3.9204, -3.9242, -3.8424, -3.6852, -3.7003,
        -3.8368, -3.8589, -3.5092, -3.0073, -3.2076, -3.7007, -3.8397, -3.8783,
        -3.8372, -3.5929, -3.5959, -3.8269, -3.9097, -3.8999, -3.8727, -3.8674,
        -3.8833, -3.9117, -3.9306, -3.9321, -3.9114, -3.9066, -3.8944, -3.8607,
        -3.8607, -3.8991, -3.8845, -3.8544, -3.8480, -3.8534, -3.8846, -3.8899,
        -3.8729, -3.8610, -3.8685, -3.8745, -3.8803, -3.8765, -3.8658, -3.8625,
        -3.9085, -3.9172, -3.8981, -3.8447, -3.6932, -3.4829, -3.5606, -3.8017,
        -3.8171, -3.0830, -2.3739, -2.7473, -3.6640, -3.8629, -3.8694, -3.8866,
        -3.9078, -3.9073, -3.9096, -3.9023, -3.8778, -3.8915, -3.9006, -3.9050,
        -3.9110, -3.8895, -3.8693, -3.9057, -3.9233, -3.9049, -3.9033, -3.8843,
        -3.8517, -3.8490, -3.8745, -3.8969, -3.8865, -3.8883, -3.9156, -3.8928,
        -3.8565, -3.8613, -3.8763, -3.8743, -3.8610, -3.8211, -3.8015, -3.8516,
        -3.8652, -3.8343, -3.6076, -3.4368, -3.6774, -3.8507, -3.8632, -3.8750,
        -3.8924, -3.9115, -3.9058, -3.8707, -3.8486, -3.8444, -3.8690, -3.8937,
        -3.8942, -3.9052, -3.9358, -3.9166, -3.8846, -3.8726, -3.8691, -3.8547,
        -3.8605, -3.8738, -3.8603, -3.8690, -3.9089, -3.8950, -3.8459, -3.8306,
        -3.8064, -3.8247, -3.8531, -3.8240, -3.7417, -3.5379, -3.6075, -3.8350,
        -3.8715, -3.8815, -3.9166, -3.8506, -3.8155, -3.8901, -3.9147, -3.9038,
        -3.8706, -3.8555, -3.8731, -3.8861, -3.9086, -3.9085, -3.8763, -3.8672,
        -3.8802, -3.8965, -3.8780, -3.8666, -3.8644, -3.8869, -3.9113, -3.9151,
        -3.9093, -3.9032, -3.9154, -3.9239, -3.9469, -3.9412, -3.9393, -3.9403,
        -3.9215, -3.9088, -3.8874, -3.8943, -3.9074, -3.8817, -3.8322, -3.8325,
        -3.8859, -3.9138, -3.9266, -3.9203, -3.8347, -3.8175, -3.8674, -3.8845,
        -3.8893, -3.9194, -3.9357, -3.9330, -3.9460, -3.9383, -3.9283, -3.9227,
        -3.9101, -3.9046, -3.9206, -3.9479, -3.9160, -3.8676, -3.8830, -3.9194,
        -3.9317, -3.9255, -3.8988, -3.8915, -3.8904, -3.8985, -3.9113, -3.8813,
        -3.8339, -3.8650, -3.8776, -3.8679, -3.8904, -3.8939, -3.8725, -3.8445,
        -3.8102, -3.8400, -3.8800, -3.8725, -3.7202, -3.5306, -3.6926, -3.9009,
        -3.9181, -3.8846, -3.8736, -3.8696, -3.8786, -3.8690, -3.8636, -3.8884,
        -3.8827, -3.8701, -3.8704, -3.8469, -3.8286, -3.8270, -3.8459, -3.8819,
        -3.9171, -3.9364, -3.9316, -3.9067, -3.8859, -3.8752, -3.8591, -3.8555,
        -3.8615, -3.8636, -3.8237, -3.8008, -3.8524, -3.8844, -3.8208, -3.5874,
        -3.5658, -3.7478, -3.8167, -3.8142, -3.7931, -3.6637, -3.5814, -3.7268,
        -3.7937, -3.7658, -3.7297, -3.7086, -3.7167, -3.7376, -3.7286, -3.7017,
        -3.6788, -3.6453, -3.6144, -3.6134, -3.6255, -3.6045, -3.5282, -3.4728,
        -3.4443, -3.4083, -3.3914, -3.3589, -3.2987, -3.2191, -3.0888, -3.0044,
        -3.0273, -3.0745, -3.0986, -3.0909, -3.0572, -2.9739, -2.8711, -2.8010,
        -2.6636, -2.5449, -2.4311, -2.4190, -2.4067, -2.2589, -1.9942, -1.9256,
        -1.9874, -1.9544, -1.8817, -1.8620, -1.8920, -1.7929, -1.5854, -1.2510,
        -1.0253, -1.0330, -1.1698, -1.5322, -1.9331, -2.2070, -2.3413, -2.3238,
        -2.3073, -2.3256, -2.3882, -2.4674, -2.5518, -2.6250, -2.7161, -2.7982,
        -2.8213, -2.7970, -2.8083, -2.7813, -2.7966, -2.9151, -3.0472, -3.1149,
        -3.0864, -2.9833, -3.0179, -3.0855, -3.1748, -3.2914, -3.3695, -3.3705,
        -3.4526, -3.5354, -3.5531, -3.5896, -3.5733, -3.5732, -3.6108, -3.6391,
        -3.6773, -3.7369, -3.7511, -3.7647, -3.7913, -3.7942, -3.7833, -3.7758,
        -3.7815, -3.7996, -3.8059, -3.8245, -3.8552, -3.8591, -3.8431, -3.8405,
        -3.8451, -3.8959, -3.9175, -3.8851, -3.8523, -3.8598, -3.8634, -3.8585,
        -3.8805, -3.8664, -3.7948, -3.7381, -3.8155, -3.8553, -3.8085, -3.4044,
        -3.1448, -3.5463, -3.8488, -3.8879, -3.9189, -3.9298, -3.9131, -3.9107,
        -3.9112, -3.8969, -3.9085, -3.8939, -3.8807, -3.9347, -3.9707, -3.9692,
        -3.9573, -3.9336, -3.9193, -3.9257, -3.9322, -3.9362, -3.9234, -3.8718,
        -3.8027, -3.8762, -3.9266, -3.9264, -3.8368, -3.5762, -3.5913, -3.8439,
        -3.8987, -3.4913, -2.8370, -3.0147, -3.7321, -3.9148, -3.9168, -3.9113,
        -3.8586, -3.8604, -3.9159, -3.9363, -3.9282, -3.9127, -3.9237, -3.9426,
        -3.9547, -3.9310, -3.8993, -3.9204, -3.9678, -3.9678, -3.9498, -3.9362,
        -3.9487, -3.9316, -3.9113, -3.9234, -3.9424, -3.9442, -3.9518, -3.9439,
        -3.9527, -3.9546, -3.9372, -3.9402, -3.9206, -3.9222, -3.9500, -3.9609,
        -3.9335, -3.8873, -3.8923, -3.8211, -3.6720, -3.7410, -3.9109, -3.9058,
        -3.5136, -2.9555, -3.1707, -3.7671, -3.8810, -3.8901, -3.8902, -3.8764,
        -3.9029, -3.9010, -3.8634, -3.8428, -3.8357, -3.8444, -3.8435, -3.8329,
        -3.8044, -3.7818, -3.7462, -3.7082, -3.7250, -3.7502, -3.7494, -3.7413,
        -3.7442, -3.7410, -3.7231, -3.6875, -3.6607, -3.6488, -3.5872, -3.5287,
        -3.6556, -3.7403, -3.6860, -3.2889, -3.1279, -3.5242, -3.7444, -3.7780,
        -3.7776, -3.7727, -3.7870, -3.8136, -3.8398, -3.9009, -3.9122, -3.9065,
        -3.8980, -3.8931, -3.9104, -3.9275, -3.9316, -3.9127, -3.8932, -3.8885,
        -3.9243, -3.9405, -3.9487, -3.9687, -3.9934, -3.9844, -3.9650, -3.9329,
        -3.9360, -3.9684, -3.9846, -3.9957, -3.9838, -3.9650, -3.9781, -3.9970,
        -4.0088, -4.0065, -3.9870, -3.9998, -3.9974, -3.9394, -3.9242, -3.9839,
        -3.9981, -3.9435, -3.7507, -3.6682, -3.8799, -4.0073, -4.0242, -4.0282,
        -3.9885, -3.9559, -3.9658, -4.0073, -4.0266, -4.0044, -4.0130, -4.0353,
        -4.0279, -4.0156, -3.9943, -3.9872, -4.0192, -4.0358, -4.0165, -4.0059,
        -4.0319, -4.0411, -4.0346, -4.0350, -4.0047, -3.9778, -4.0036, -4.0426,
        -4.0222, -4.0113, -4.0165, -3.9974, -3.9582, -3.8720, -3.9252, -4.0070,
        -4.0488, -4.0501, -4.0023, -3.9550, -3.9669, -4.0070, -4.0385, -4.0269,
        -4.0266, -4.0184, -4.0116, -4.0307, -4.0049, -3.9791, -3.9964, -4.0206,
        -4.0376, -4.0283, -4.0061, -4.0157, -4.0370, -4.0335, -4.0666, -4.0820,
        -4.0452, -4.0400, -4.0615, -4.0331, -4.0006, -4.0199, -4.0586, -4.0496,
        -4.0417, -4.0466, -4.0448, -4.0104, -4.0111, -4.0591, -4.0164, -3.8381,
        -3.8691, -3.9921, -3.9770, -3.5247, -3.0571, -3.3957, -3.9516, -4.0421,
        -4.0736, -4.0989, -4.0729, -4.0750, -4.0963, -4.0798, -4.0619, -4.0667,
        -4.0796, -4.0717, -4.0387, -4.0436, -4.0540, -4.0761, -4.0972, -4.1186,
        -4.1216, -4.1136, -4.1034, -4.1072, -4.1111, -4.0903, -4.0886, -4.0801,
        -4.0878, -4.1195, -4.1234, -4.1069, -4.0927, -4.0893, -4.0758, -4.0792,
        -4.0932, -4.0624, -4.0430, -4.0620, -4.0529, -4.0403, -4.0258, -4.0360,
        -4.0712, -4.0921, -4.0408, -3.9407, -3.9811, -4.0413, -4.0849, -4.1224,
        -4.1161, -4.0848, -4.0741, -4.0722, -4.0704, -4.0996, -4.1203, -4.1014,
        -4.0624, -4.0718, -4.0919, -4.0965, -4.1185, -4.1238, -4.1073, -4.1050,
        -4.1029, -4.0985, -4.0933, -4.0883, -4.0749, -4.0412, -3.9476, -3.7797,
        -3.3268, -3.2130, -3.7493, -4.0202, -3.1798, -1.9569, -1.9219, -3.1059,
        -4.0389, -4.1317, -4.1268, -4.0893, -4.0630, -4.0626, -4.0080, -3.5428,
      };
      const noise_model noise = nle->estimate(data, sizeof(data) / sizeof(float));

      CPPUNIT_ASSERT_DOUBLES_EQUAL(noise.lvl(-1), -4.04462430791, 0.0005);
      CPPUNIT_ASSERT_DOUBLES_EQUAL(noise.mean_lvl(), -3.98256862712, 0.00001);
      CPPUNIT_ASSERT_DOUBLES_EQUAL(noise.lvl(1), -3.92051294634, 0.0005);
    }

  } /* namespace rstt */
} /* namespace gr */

